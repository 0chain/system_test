name: "0Chain System Tests"

on:
  push:
  workflow_dispatch:
    inputs:
      test_run_description:
        description: '(OPTIONAL) Add a description/label for this test run. This will allow you to differentiate between test runs later'
        default: ''
        required: false
      zbox_cli_branch:
        description: '0Box CLI (branch or commit SHA) which the tests will use'
        default: 'staging'
        required: true
      zwallet_cli_branch:
        description: '0Wallet CLI (branch or commit SHA) which the tests will use'
        default: 'staging'
        required: true
      existing_network:
        description: '(OPTIONAL): EXISTING NETWORK to run system tests against INSTEAD OF DEPLOYING A NEW NETWORK. [example: dev.0chain.net]'
        default: ''
        required: false
      miner_image:
        description: 'miner DOCKER IMAGE to deploy'
        default: 'staging'
        required: false
      sharder_image:
        description: 'sharder DOCKER IMAGE to deploy'
        default: 'staging'
        required: false
      blobber_image:
        description: 'blobber DOCKER IMAGE to deploy'
        default: 'staging'
        required: false
      validator_image:
        description: 'validator DOCKER IMAGE to deploy'
        default: 'staging'
        required: false
      zbox_image:
        description: '0box DOCKER IMAGE to deploy'
        default: 'staging'
        required: false
      zblock_image:
        description: '0block DOCKER IMAGE to deploy'
        default: 'staging'
        required: false

jobs:
  golangci:
    if: github.event_name == 'push'
    name: "lint"
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v2
        with:
          version: v1.42
          skip-build-cache: true
          skip-pkg-cache: true
          only-new-issues: true

  system-tests:
    name: "System Tests"
    runs-on: [ tests-suite ]
    timeout-minutes: 40
    steps:

      - name: "Config: Run tests against existing 0Chain network"
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.existing_network != ''
        run: |
          echo "NETWORK_URL=$(echo ${{ github.event.inputs.existing_network }})" >> $GITHUB_ENV

      - name: "Config: Deploy new 0Chain network then run tests against it"
        if: github.event_name == 'push' || github.event.inputs.existing_network == ''
        run: |
          echo "NETWORK_URL=$(echo dev-${RUNNER_NAME:(-1)}.devnet-0chain.net)" >> $GITHUB_ENV
          echo "RUNNER_NUMBER=${RUNNER_NAME:(-1)}" >> $GITHUB_ENV

      - name: "Deploy 0Chain"
        if: github.event_name == 'push' || github.event.inputs.existing_network == ''
        uses: 0chain/system_test/deploy-0chain@feature/composite-action
        with:
          kube_config: ${{ secrets[format('DEV{0}KC', env.RUNNER_NUMBER)] }}
          miner_image: staging-556fedc2
          sharder_image: staging-556fedc2
          blobber_image: ${{github.event.inputs.blobber_image}}
          validator_image: ${{github.event.inputs.validator_image}}
          zbox_image: ${{github.event.inputs.zbox_image}}
          zblock_image: ${{github.event.inputs.zblock_image}}
          zdns_image: ${{github.event.inputs.zdns_image}}
          explorer_image: ${{github.event.inputs.explorer_image}}
          zproxy_image: ${{github.event.inputs.zproxy_image}}
          zsearch_image: ${{github.event.inputs.zsearch_image}}
          blobber_stake_image: ${{github.event.inputs.blobber_stake_image}}

      - name: "Run System tests"
        uses: 0chain/system_test/run-system-tests@feature/composite-action
        with:
          network: env.NETWORK_URL
          zbox_cli_branch: ${{github.event.inputs.zbox_cli_branch}})
          zwallet_cli_branch: ${{github.event.inputs.zwallet_cli_branch}})
          smart_contract_owner_wallet_json: ${{ secrets.SMART_CONTRACT_OWNER_WALLET_JSON }}
          svc_account_secret: ${{ secrets.SVC_ACCOUNT_SECRET }}
          deploy_report_page: true
          archive_results: true
          run_flaky_tests: true